# 介绍

> 在说明事务之前，我们来看一个业务场景，假如要解散教研部，我希望在删除教研部的同时将该部门下的所有员工一并删除，当然这只是一种假设，在真实的开发中即使部门解散了，该部门下的员工也不一定真的被删除。
>
> 对应的sql语句：

![image-20240406195508987](D:\text1\9.MySQL\assets\image-20240406195508987.png)

> 现在我们同时执行这两条sql，部门和对应的员工都被删除了：

![image-20240406195557159](D:\text1\9.MySQL\assets\image-20240406195557159.png)

![image-20240406195606053](D:\text1\9.MySQL\assets\image-20240406195606053.png)

> 现在我想删除咨询部，但是这里我来模拟一种情况，就是删除咨询部的sql能执行，但是删除对应员工的sql遇到了错误无法执行，因此我们故意写错以模拟此场景：

![image-20240406195824248](D:\text1\9.MySQL\assets\image-20240406195824248.png)

> 现在我们同时执行，先来看部门表：

![image-20240406195917793](D:\text1\9.MySQL\assets\image-20240406195917793.png)

> 咨询部被成功删除了，但是员工表中对应的员工却没有被删除：

![image-20240406200002342](D:\text1\9.MySQL\assets\image-20240406200002342.png)

> 在操作前后，数据出现了不一致的问题。
>
> 当我们删除部门时，同时还要去删除对应的员工，当两条sql能正常执行能够确保同时删除，但是当某一条sql执行失败时，就会造成一边成功删除，另一边删除失败的情况，导致数据不一致，要想解决这类问题，我们可以通过数据库中的事务来处理。



# 什么是事务

> 事务就是一组操作的集合，它是一个不可分割的工作单位，事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求，即这些操作<font color='yellow'>要么同时成功，要么同时失败</font>。
>
> 我们再来看解散部门的需求，删除部门的同时要删除部门下的员工，这两步操作很明显是一个整体，是一个不可分割的工作单位，显然它们是一个事务，因此就需要保证这两步操作要么同时成功，要么同时失败，只有这样才不会出现上面数据不一致的情况。
>
> 现在的问题是，为什么删除部门成功了，但是删除员工却失败了，这个整体没有同时失败？
>
> 因为在MySQL数据库中，事务默认是自动提交的。即，当执行一条DML语句，MySQL立即隐式的提交事务，也就是说当我们第一条删除部门的语句执行后事务会立即提交，而下面删除员工的语句又是另一个事务，即两者不是同一个事务，这才导致没有同时失败。
>
> 我先在要做的就是将两个事务控制在一个事务中。



# 事务操作

```sql
-- 开启事务
start transaction;  
-- 或者
begin;

-- 提交事务
commit;

-- 回滚事务
rollback;
```

> 我们可以在业务操作执行之前执行开启事务的指令，来开启一个事务。
>
> 当这个业务的所有操作都执行成功后我们在来提交事务，提交事务就是将本次业务中的操作真正的提交到数据库中，也就是说如果你没有提交事务，即使业务操作是成功执行的，也不会真正的影响到表。
>
> 最后是回滚事务，当业务操作中出现错误时，我们可以恢复到执行操作之前的状态。
>
> 来看代码：

![image-20240406204428030](D:\text1\9.MySQL\assets\image-20240406204428030.png)

> 我们先执行start transaction ;开启事务：

![image-20240406202445897](D:\text1\9.MySQL\assets\image-20240406202445897.png)

> 然后再执行业务操作：

![image-20240406204420185](D:\text1\9.MySQL\assets\image-20240406204420185.png)

> 员工表和部门表的数据，员工表和部门表都没有被删除：

![image-20240406204220378](D:\text1\9.MySQL\assets\image-20240406204220378.png)

![image-20240406203153247](D:\text1\9.MySQL\assets\image-20240406203153247.png)

> 其实我在当前窗口执行的事务，这个事务只要还没提交，那么在其他窗口是看不见的，窗口之间是相互隔离的，我在当前创建执行查询语句：

![image-20240406203447663](D:\text1\9.MySQL\assets\image-20240406203447663.png)

![image-20240406203506172](D:\text1\9.MySQL\assets\image-20240406203506172.png)

![image-20240406203515391](D:\text1\9.MySQL\assets\image-20240406203515391.png)

> 可以发现两张表的数据都被删除了，只是在当前窗口中是这样的，且该事务还没有提交，所以在其他创建看见的数据是没有被删除的，一旦我执行提交：

![image-20240406204344709](D:\text1\9.MySQL\assets\image-20240406204344709.png)

![image-20240406204352842](D:\text1\9.MySQL\assets\image-20240406204352842.png)

> 其他窗口看见的数据就是删除后的数据了。
>
> 现在我们模拟异常情况：

![image-20240406204550540](D:\text1\9.MySQL\assets\image-20240406204550540.png)

> 开启事务：

![image-20240406204620500](D:\text1\9.MySQL\assets\image-20240406204620500.png)

> 执行业务操作：

![image-20240406204649696](D:\text1\9.MySQL\assets\image-20240406204649696.png)

> 在当前窗口下查询：

![image-20240406204805444](D:\text1\9.MySQL\assets\image-20240406204805444.png)

![image-20240406204813721](D:\text1\9.MySQL\assets\image-20240406204813721.png)

> 部门表的数据被删除了，员工表没有，现在执行回滚：

![image-20240406204846557](D:\text1\9.MySQL\assets\image-20240406204846557.png)

> 部门表的数据恢复了：

![image-20240406204908534](D:\text1\9.MySQL\assets\image-20240406204908534.png)



# 四大特性(ACID)

> 事务的四大特性：
>
> - 原子性(Atomicity)：事务是不可分割的最小单元，业务操作要么全部成功，要么全部失败
> - 一致性(Consistency)：事务完成时，必须使所有数据都保存一致
> - 隔离性(Isolation)：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行
> - 持久性(Durability)：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的
>
> 四大特性根据首字母又被叫做ACID